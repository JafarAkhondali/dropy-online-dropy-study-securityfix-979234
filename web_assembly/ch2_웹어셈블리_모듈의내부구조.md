# Chapter 2 웹어셈블리 모듈의 내부 구조

*자세한 모듈 내부 구조는 다음 장 이후로도 계속 나옴. 하지만 모듈의 구조와 각 섹션의 작동 원리를 알아야 웹어셈블리를 이해 및 개발할 수 있음.*



웹어셈블리 모듈을 여러 섹션으로 나누면 다음과 같은 이점이 있다.

- 효율(efficiency): 바이너리 바이트코드를 단일 패스로 파싱, 검증, 컴파일할 수 있다.
- 스트리밍(streaming): 모든 데이터를 내려받기 전에 파싱, 검증, 컴파일을 시작할 수 있다.
- 병렬성(parallelization): 파싱, 검증, 컴파일을 병렬 처리할 수 있다.
- 보안(security): 모듈은 디바이스 메모리에 직접 접근할 수 없고 코드 대신 함수 포인터 등을 호출한다.



**웹어셈블리 모듈의 모든 섹션은 옵션이다. 따라서 섹션이 하나도 없는 빈 모듈도 얼마든지 가능하다.**

섹션은 크게 두 가지로 분류한다.

- 표준 섹션
  - 표준섹션은 목표가 정해져 있어서 구조가 명확하며, 어셈블리 모듈 인스턴스 화 시 검증 과정을 거친다.
- 커스텀 섹션
  - 표준 섹션 이전, 중간, 이후 어디든지 올 수 있다.





## 2.1 표준 섹션

*표준 섹션은 각각 한 번만 나올 수 있고 지금부터 열거하는 순서대로 등장해야 한다.*



##### 1. Type

Type 섹션에는 임포트할 함수를 비롯해 모듈에서 사용하는 모든 고유한(중복되지 않는) 함수 시그니처(function signature) 목록을 선언한다. 동일한 함수 시그니처는 여러 함수가 공유할 수 있다.



##### 2. Import

Import 섹션에는 함수, 테이블, 메모리, 글로벌 등 모듈에서 사용할 모든 임포트를 선언한다.

임포트는 모듈 간에 코드/데이터를 공유하기 위한 장치지만, 모듈을 독립적으로 컴파일/캐시할 수도 있다. 임포트는 모듈 인스턴스화 시 호스트 환경에서 제공한다.

##### 3. Function

Function 섹션은 모듈에 있는 함수의 전체 목록이다. 여기서 함수가 선언된 위치가 곧 Code 섹션의 함수 본문 인덱스, Function 섹션에 나열된 값이 Type 섹션에 있는 함수 시그니처의 인덱스 이다.




##### 4. Table

Table 섹션에는 함수처럼 모듈의 선형 메모리에 원(raw)바이트 그대로 저장할 수 없는, 정형한 레퍼런스 배열을 담는다. 이 섹션은 웹어셈블리 프레임워크에서 안전하게 객체를 매핑할 수 있는 수단으로서, 웹어셈블리 보안의 핵심 요소 중 하나다.





##### 5. Memory

Memory 섹션은 모듈 인스턴스에서 사용하는 선형 메모리이다.





##### 6. Global

모듈에서 사용할 전역 변수를 정의한다.



##### 7. Export

모듈 인스턴스 화 후 호스트 환경으로 변환할 모든 객체 목록(즉, 호스트 환경에서 접근 가능한 모듈의 일부)을 담는다. ex: 함수, 테이블, 메모리, 글로벌 익스포트



##### 8. Start

모듈 인스턴스 이후, 그러나 익스포트된 함수가 호출 가능한 상태가 되기 이전에 호출할 함수 인덱스를 선언한다. 스타트 함수를 활용하면 전역 변수 또는 메모리를 인스턴스화할 수 있다. 이 섹션이 지정되면 함수는 임포트할 수 없으며 반드시 모듈 안에 있어야 한다.



##### 9. Element

모듈 인스턴스화 시 Table 섹션으로 로드할 데이터를 선언한다.



##### 10. Code

Function 섹션에서 선언한 각 함수의 본문이 있다. 함수 본문의 순서는 함수 시그니처가 선언된 순서와 동일하다.



##### 11. Data

모듈 인스턴스화 시 선형 메모리에 로드할 데이터를 선언한다.



## 2.2 커스텀 섹션

- 커스텀 섹션은 모듈의 어느 위치라도 횟수 제한 없이 사용할 수 있다.
- 다수의 커스텀 섹션이 동일한 이름을 재사용하는 것도 가능하다.
- 프레임워크가 레이지로딩을 할 수 있어서 커스텀 섹션에 포함된 데이터는 모듈 인스턴스화 이후 특정 시점까지는 사용할 수 없는 경우도 있다.
- 커스텀 섹션의 한 가지 용도는 웹어셈블리 MVP에 정의된 name 섹션이다.
  - 디버깅 시 함수명, 변수명을 텍스트 포맷으로 모듈에 담아두려고 만든 것이다.
  - 다른 커스텀 섹션과는 다르게 Data 섹션 다음에 단 한번만 올 수 있다.



## 2.3 마치며

- 웹어셈블리 모듈의 섹션과 그 설계 원리는 웹어셈블리의 특장점을 잘 보여준다.
- 컴파일러는 웹어셈블리 모듈의 섹션을 생성하고 올바른 순서로 배치한다.
- 웹어셈블리 모듈의 섹션은 모두 옵션이라서 빈 모듈도 얼마든지 가능하다.
- 표준 섹션은 한번만 지정할 수 있고 정해진 순서대로 나와야 한다.
- 표준 섹션에 해당되지 않는 데이터는 커스텀 섹션에 지정하며 표준 섹션 앞뒤, 중간 어디든 둘 수 있다.




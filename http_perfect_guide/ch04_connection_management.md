# 커넥션 관리

## 1. HTTP 통신 흐름을 TCP Socket API와 함께 보기

![figure4_1](https://user-images.githubusercontent.com/47515936/79689790-fc1f4d00-8291-11ea-94e5-ed4ae1e1d051.png)

## 2. HTTP 성능에 영향을 미치는 TCP 요소들

### 2.1. TCP 커넥션 핸드셰이크 지연

작은 HTTP 트랜잭션의 경우 50% 이상이 핸드셰이크 비용이다. 따라서 다음의 개선책들을 활용한다.

1. **마지막 ACK 응답에 요청 메시지를 포함**해서 전달한다.
2. **확인응답 지연 알고리즘**
    - 확인응답을 0.1 ~ 0.2초 버퍼에 저장해두고, 패킷에 편승시킨다.
    - 안타깝게 HTTP 프로토콜은 요청 > 응답의 메커니즘을 가지기 때문에 확인응답 지연으로 득을 보기보다는 실이 발생하는 경우가 더 많다.

### 2.2. TCP 의 느린 시작

TCP 커넥션은 만들어질 때 느리지만, **데이터가 성공적으로 전송됨에 따라 튜닝되며 속도가 높아진다.**  
이는 인터넷의 급작스러운 부하를 막는다. 따라서 성능을 개선하기 위해 튜닝된 커넥션을 재사용하는 **지속 커넥션**을 사용한다.

### 2.3. Nagle 알고리즘

네트워크의 효율을 위해서 하나의 패킷에 최대한 많은 데이터를 보내는 것이다.
이는 **패킷의 최대 크기를 만족시키거나, ACK를 받았을 경우에만 패킷의 전송을 허락**한다.

따라서 **크기가 작은 HTTP 패킷의 경우 불필요한 지연이 발생**하며, 확인응답 지연 알고리즘이나 커넥션의 파이프라이닝으로 지연이 더욱 커질 수 있다.

이를 제어하기 위해 TCP_NODELAY 파라미터를 설정하기도 한다.

<img width="1000" alt="nagle algorithm" src="https://user-images.githubusercontent.com/47515936/79690060-7d2b1400-8293-11ea-89d3-df3f10e5b8b3.png">



# 18장 웹 호스팅
> 콘텐츠 리스소를 저장, 중개, 관리하는 일을 통틀어 웹 호스팅이라 한다.

## 호스팅 서비스
- 물리적인 장비 관리 (공간, 냉난방, 연결)
- 고객이 직접 웹 콘텐츠를 제공할 수 있도록 함
- 간단한 예: 전용 호스팅

  - 죠, 메리: 고성능 웹 서버를 대여함
  - 아이린 ISP: 고성능 웹서버들을 갖고 있고, 이를 대여해줌

## 가상 호스팅 (또는 공유 호스팅)
- 컴퓨터 한 대를 여러 고객이 공유
- 각 웹사이트는 다른 서버에서 호스팅하는 것처럼 보임
  - but, **물리적으로 같은 서버에서 호스팅**된다.
- 호스팅 업자는 **서버팜**을 만들고 부하를 분산할 수 있다.
  - 서버 클러스터라고 불리기도 하는 서버팜은 **컴퓨터 서버와 운영 시설을 한곳에 모아 놓은 곳**으로 허가받지 않은 외부에선 접근이 불가능하며, 임의의 서버가 중단되더라도 다른 서버로 대체되어 원할한 서비스를 제공

### 호스트 정보가 없는 가상 서버 요청
- 가상 호스팅과 관련된 HTTP/1.0 명세의 설계 결함
  - `웹 사이트 호스트 정보`가 요청에서 제거됨
    - 사용자가 어떤 가상 웹 사이트로 접근하려고 하는 것인지 아는 데 필요한 정보가 충분하지 않음
    - HTTP/1.0 설계자들은 가상 호스팅을 고려하지 않음
  - HTTP/1.0 요청은 요청 메시지에 **URL의 경로** 정보만 전송함
    - 두 요청이 (서로 다른 웹 사이트에) 완전히 다른 문서를 요청하더라도, 요청 자체는 똑같다.
      - `http://www.joes-hardware.com/index.html` -> `GET /index.html` (호스트 명에 대한 별다른 언급 X)
      - `http://www.marys-antiques.com/index.html` -> `GET /index.html` (호스트 명에 대한 별다른 언급 X)

### 가상 호스팅 동작하게 하기
> 가상 호스팅과 관련된 HTTP/1.0 명세의 설계 결함에 대한 해결책

- HTTP/1.1
  - 요청에 완전한 URL도 포함되도록 함
  - HTTP/1.1을 지원하는 서버는 hTTP 요청 메시지에 있는 전체 URL을 처리할 수 있어야 함
  - **한계**
    - 기존에 있던 모든 애플리케이션이 HTTP/1.1 명세에 맞추어 업그레이드 되야함 (오래 걸림 = 당장 사용될 수 있는 해결책은 아님)
- URL 경로를 통한 가상 호스팅
  - 각각의 가상 웹 사이트에 **서로 다른 URL 경로 할당**
    - `http://www.joes-hardware.com/joe/index.html` -> `GET /joe/index.html` (죠의 사이트에 대한 요청)
    - `http://www.marys-antiques.com/mary/index.html` -> `GET /mary/index.html` (메리의 사이트에 대한 요청)
    - **단점**
      - `/joe`와 `/mary`와 같은 불필요한 접두어는 혼란을 일으킬 수 있음
      - `http://www.joes-hardware.com` 나 `http://www.joes-hardware.com/index.html` 와 같은 일반적인 URL 사용 불가능
    - 일반적으로, URL 기반의 가상 호스팅은 좋지 않은 방법 -> 거의 사용하지 않음
- 포트번호를 통한 가상 호스팅
  - 웹 서버에 각각 **다른 포트번호** 할당
    - `http://www.joes-hardware.com` -> `82번 포트번호` 할당
    - `http://www.marys-antiques.com/index.html` -> `83번 포트번호` 할당
  - 사용자는 비표준 포트를 쓰지 않고서도 사이트에 접근하고자 하기에 이 방식은 잘 사용되지 않음
- IP 주소를 통한 가상 호스팅
  - 각각의 가상 웹 사이트에 **유일한 IP 주소** 를 한 개 이상 부여
  - 모든 가상 서버의 IP 주소는 같은 공용 서버에 연결되어 있음
    - `http://www.joes-hardware.com/index.html` 에 `209.172.34.3` 할당
    - `http://www.marys-antiques.com/index.html` 에 `209.172.34.4` 할당
  - **한계**
    - 할당 받을 수 있는 IP 개수는 제한됨
    - IP 주소는 희소함
  - 가상 IP 호스팅은 IP 주소 부족 문제가 생길 수 있음에도 불구하고, **널리 쓰이는 방식**
- Host 헤더를 통한 가상 호스팅
  - 모든 요청에 호스트 명(그리고 포트)을 **Host 확장 헤더**에 기술해서 전달 (HTTP/1.1 명세)
    - Host 헤더는 HTTP/1.0+ 에서 처음 소개됨

### HTTP/1.1 Host 헤더
- 요청 리소스에 대한 **인터넷 호스트**와 **포트번호**가 기술됨
- `Host: 호스트명[: 포트]`
- 규칙
  - Host 헤더에 포트가 기술되어 있지 않으면, 해당 스킴의 기본 포트 사용
  - URL에 `IP 주소`가 있으면, Host 헤더는 같은 `IP 주소`를 포함해야 함
  - URL에 `호스트 명`이 있으면, Host 헤더는 같은 `호스트 명`을 포함해야 함
  - 프락시 서버를 사용한다면, Host 헤더에 프락시 서버가 아닌 **원 서버의 호스트명과 포트**를 기술해야 한다.
  - HTTP/1.1 웹 서버는 Host 헤더 필드가 없는 HTTP/1.1 요청 메시지를 받으면 **400 상태 코드** 응답
- Host 헤더 해석 규칙
  - HTTP 요청 메시지에 전체 URL이 기술되어 있으면, Host 헤더 무시
  - HTTP 요청 메시지에 호스트 명이 기술되어 있지 않다면, 호스트명과 포트를 Host 헤더에서 가져온다.
  - 위 두 단계를 거쳐도 호스트를 결정할 수 없으면, 400 Bad Request 응답 반환

## 안정적인 웹 사이트 만들기
> 웹 사이트 장애를 예측하고 대응하는 방법

### 미러링 된 서버 팜
- **서버팜**은 서로 대신할 수 있고, 각각 식별할 수 있게 설정된 웹 서버들의 집합
- 서버팜의 서버에 있는 콘텐츠들를 전달하는 특정 서버에 문제가 생기면, 다른 서버에서 해당 콘텐츠를 전달할 수 있도록 **미러링** 된다.
- 미러링된 서버들은 **계층적인 관계**를 갖고 있음
  - 마스터 원 서버
    - 원본 콘텐츠를 갖고 있음
  - 복제 원서버
    - 마스터 원 서버로부터 콘텐츠를 받은 미러링 된 서버
- 클라이언트는 네트워크 스위치를 사용하여 서버 팜에 분산 요청을 보낸다.
  - 외부에서 볼 때, 특정 콘텐츠를 가리키는 IP주소는 스위치의 IP 주소다.
- 클라이언트의 요청이 서버팜 내 특정 서버로 가는 두 가지 방법
  - HTTP 리다이렉션
    - 콘텐츠에 대한 URL은 마스터 서버의 IP를 가리킨다.
    - 마스터 서버는 요청을 받는 즉시 복제 서버로 리다이렉트 시킨다.
  - DNS 리다이렉션
    - DNS 서버가 URL에 호스트명에 대한 응답으로 어떤 IP 주소를 사용할 지 결정

### 콘텐츠 분산 네트워크(CDN)
- 콘텐츠 분산 네트워크(CDN)는 특정 콘텐츠의 분산을 목적으로 하는 단순한 네트워크이다.
- 네트워크 노드 종류
  - 서버
  - 대리 서버 or 프락시 서버

### CDN의 대리 캐시
- 복제 원 서버를 대신해 사용됨
- 특정 원 서버 집합을 대신해 미러링된 웹 서버처럼 **콘텐츠에 대한 요청**을 받는다.
- 미러링된 서버와의 차이점
  - 대기 서버는 **수요**에 따라 동작함
    - 원 서버의 전체 콘텐츠를 복사하지 않음
    - 클라이언트가 요청하는 콘텐츠만 저장
    - 원 서버는 대리 서버의 콘텐츠를 업데이트해줄 의무 없음
  - 사용자의 요청 전에 콘텐츠를 `미리 가져오기` 기능을 가진 대리 서버도 있음

### CDN의 프락시 캐시
- 대리 서버와의 차이점
  - 어떤 웹 서버 요청이든 다 받을 수 있음
    - 원 서버와의 연동 및 IP 주소 합의가 필요 없음
- 레이어2 혹은 레이어3 장비(스위치 혹은 라우터)가 중간에서 웹 트래픽을 가로채 처리하기도 함

## 웹 사이트 빠르게 만들기
- 네트워크 내 트래픽 분산
  - 서버 팜
  - 분산 프락시 캐시
  - 대리 서버
- 콘텐츠 인코딩
  - 클라이언트가 받은 압축을 해제할 수 있따는 가정하에
